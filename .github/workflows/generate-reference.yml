name: Reference generation

permissions:
  contents: write #Write tag to release
  actions: read #Read workflows

# Make this a reusable workflow callable via workflow_call
on:
  workflow_call:
    inputs:
      release_tag:
        description: "Release tag"
        required: false
        default: ''
        type: string
      antares_tag:
        description: "Antares_Simulator solver tag"
        required: true
        type: string
      antares_tests_tag:
        description: "Antares_Simulator_Tests_NR"
        required: false
        default: ''
        type: string
      target_branch:
        description: "Target branch to create the release on"
        required: false
        default: 'main'
        type: string
    secrets:
      SIMTEST_PAT:
        description: 'Optional personal access token to use instead of the runner token'
        required: false

jobs:
    release:
      runs-on: ubuntu-latest
      # Compute inputs using workflow_call inputs
      env:
        ANTARES_TAG: ${{ inputs.antares_tag }}
        ANTARES_TESTS_TAG: ${{ inputs.antares_tests_tag }}
        TARGET_BRANCH: ${{ inputs.target_branch }}
      outputs:
        batches: ${{ steps.read_batches.outputs.batches }}
        antares_tag: ${{ steps.create_release.outputs.antares_tag }}
        antares_tests_tag: ${{ steps.create_release.outputs.antares_tests_tag }}
        release_tag: ${{ steps.create_release.outputs.release_tag }}

      steps:
        - name: Checkout SimTest
          uses: actions/checkout@v4

        - name: Prepare tokens
          # Prefer provided SIMTEST_PAT (from caller) over the automatic runner token
          run: |
            if [ -n "${{ secrets.SIMTEST_PAT || '' }}" ]; then
              echo "GITHUB_TOKEN=${{ secrets.SIMTEST_PAT }}" >> $GITHUB_ENV
              echo "SIMTEST_PAT_PROVIDED=true" >> $GITHUB_ENV
            else
              echo "GITHUB_TOKEN=${{ github.token }}" >> $GITHUB_ENV
              echo "SIMTEST_PAT_PROVIDED=false" >> $GITHUB_ENV
            fi

        - name: Validate antares_tag input
          run: |
            set -euo pipefail
            if [ -z "${ANTARES_TAG:-}" ]; then
              echo "ERROR: antares_tag must be provided via workflow inputs (antares_tag)."
              exit 1
            fi

        - id: create_release
          name: Create release
          env:
            antares_tag: ${{ env.ANTARES_TAG }}
            antares_tests_tag: ${{ env.ANTARES_TESTS_TAG }}
            target_branch: ${{ env.TARGET_BRANCH }}
            # Compute release input here (may come from workflow_call inputs)
            release_input: ${{ inputs.release_tag }}
          run: |
            set -euo pipefail

            # If this workflow is invoked from another repository, the default github.token
            # will belong to the caller and cannot create releases on this repo. Detect that
            # case early and require the caller to provide a PAT via the SIMTEST_PAT secret.
            caller_repo="$GITHUB_REPOSITORY"
            target_repo="AntaresSimulatorTeam/SimTest"
            if [ "$caller_repo" != "$target_repo" ] && [ "${SIMTEST_PAT_PROVIDED:-false}" != "true" ]; then
              echo "ERROR: this reusable workflow is being called from a different repository: $caller_repo"
              echo "The GITHUB_TOKEN provided to callers cannot create releases in $target_repo."
              echo "Please call this workflow like this from the caller repository and provide a personal access token (SIMTEST_PAT) with repo permissions:"
              echo "  jobs:\n    call:\n      uses: AntaresSimulatorTeam/SimTest/.github/workflows/generate-reference.yml@main\n      secrets: { SIMTEST_PAT: \\${{ secrets.SIMTEST_PAT }} }"
              echo "Alternatively, run the workflow from the target repository so the runner's token has the proper permissions."
              exit 1
            fi

            # Derive release tag: prefer explicit release_input, fallback to ANTARES_TAG
            if [ -n "$release_input" ]; then
              tag="$release_input"
              note_scope="(explicit release_tag provided)"
            else
              tag="$antares_tag"
              note_scope="(derived from antares_tag)"
            fi

            # If antares_tests_tag is empty, use top of main branch
            if [ -z "$antares_tests_tag" ]; then
              tests_tag="main"
              tests_note="(top of main branch)"
            else
              tests_tag="$antares_tests_tag"
              tests_note="(release tag)"
            fi

            # Title derived from Antares tag to avoid duplication
            title="SimTest reference generation $tag"

            gh release create "$tag" \
                --repo="AntaresSimulatorTeam/SimTest" \
                --title="$title" \
                --target="$target_branch" \
                --notes="Antares_Simulator: $antares_tag
                Antares_Simulator_Tests_NR: $tests_tag $tests_note" \

            # Export outputs for downstream steps
            echo "release_tag=$tag" >> $GITHUB_OUTPUT
            echo "antares_tag=$antares_tag" >> $GITHUB_OUTPUT
            echo "antares_tests_tag=$tests_tag" >> $GITHUB_OUTPUT


        - name: Checkout Antares_Simulator_Tests_NR (main)
          if: ${{ env.ANTARES_TESTS_TAG == '' }}
          uses: actions/checkout@v4
          with:
            repository: AntaresSimulatorTeam/Antares_Simulator_Tests_NR
            ref: main
            path: antares_tests

        - name: Copy study-batches.txt from main branch
          if: ${{ env.ANTARES_TESTS_TAG == '' }}
          run: |
            cp -f antares_tests/study-batches.txt study-batches.txt

        - name: Download study-batches.txt from release
          if: ${{ env.ANTARES_TESTS_TAG != '' }}
          run: |
            set -euo pipefail
            echo "Using release tag ${{ env.ANTARES_TESTS_TAG }} to download study-batches.txt"
            wget https://github.com/AntaresSimulatorTeam/Antares_Simulator_Tests_NR/releases/download/${{ env.ANTARES_TESTS_TAG }}/study-batches.txt

        - name: Read study-batches.txt
          id: read_batches
          run: |
            BATCHES=$(printf '"%s",' $(cat study-batches.txt) | sed "s/^/[/;s/,$/]/")
            echo "batches=$BATCHES" >> $GITHUB_OUTPUT

        - name: Upload study-batches.txt
          env:
            tag: ${{ steps.create_release.outputs.release_tag }}
          run: |
            gh release upload "$tag" study-batches.txt --repo="AntaresSimulatorTeam/SimTest"

    generation:
        runs-on: ${{ matrix.os }}
        needs: release
        strategy:
          fail-fast: false
          matrix:
            batch: ${{ fromJson(needs.release.outputs.batches) }}
            os: [ubuntu-22.04, windows-2022]

        steps:
        - name: Checkout SimTest
          uses: actions/checkout@v4

        - name: Prepare tokens
          # Prefer provided SIMTEST_PAT (from caller) over the automatic runner token
          run: |
            if [ -n "${{ secrets.SIMTEST_PAT || '' }}" ]; then
              echo "GITHUB_TOKEN=${{ secrets.SIMTEST_PAT }}" >> $GITHUB_ENV
              echo "SIMTEST_PAT_PROVIDED=true" >> $GITHUB_ENV
            else
              echo "GITHUB_TOKEN=${{ github.token }}" >> $GITHUB_ENV
              echo "SIMTEST_PAT_PROVIDED=false" >> $GITHUB_ENV
            fi

        - name: Pre-requisites (Windows)
          if: ${{ startsWith(matrix.os, 'windows') }}
          run: choco install wget zip unzip --no-progress

        - name: Download, unpack Antares_Simulator, clean archive (Ubuntu)
          if: ${{ startsWith(matrix.os, 'ubuntu') }}
          run: |
            wget https://github.com/AntaresSimulatorTeam/Antares_Simulator/releases/download/${{ needs.release.outputs.antares_tag }}/antares-solver_ubuntu22.04.tar.gz -O antares_simulator.tar.gz
            tar xf antares_simulator.tar.gz
            rm antares_simulator.tar.gz

        - name: Download, unpack Antares_Simulator, clean archive (Windows)
          if: ${{ startsWith(matrix.os, 'windows') }}
          run: |
            wget https://github.com/AntaresSimulatorTeam/Antares_Simulator/releases/download/${{ needs.release.outputs.antares_tag }}/antares-solver_windows.zip -O antares_simulator.zip
            unzip -q antares_simulator.zip
            rm antares_simulator.zip

        - name: Checkout Antares_Simulator_Tests_NR (main)
          if: ${{ needs.release.outputs.antares_tests_tag == 'main' }}
          uses: actions/checkout@v4
          with:
            repository: AntaresSimulatorTeam/Antares_Simulator_Tests_NR
            ref: main
            path: Antares_Simulator_Tests_NR

        # If the release output antares_tests_tag is "main", copy the batch zip from the checked-out repository;
        # otherwise fetch from the release asset for that tag.

        - name: Copy Antares_Simulator_Tests batch from main branch
          if: ${{ needs.release.outputs.antares_tests_tag == 'main' }}
          shell: bash
          run: |
            set -euo pipefail
            echo "Preparing ${{ matrix.batch }} from checked-out Antares_Simulator_Tests_NR (main)"
            # If there's a directory for the batch, copy it directly into the workspace (no zip/unzip required)
            if [ -d "Antares_Simulator_Tests_NR/${{ matrix.batch }}" ]; then
              echo "Copying directory Antares_Simulator_Tests_NR/${{ matrix.batch }} -> ./"
              rm -rf "${{ matrix.batch }}" || true
              cp -a "Antares_Simulator_Tests_NR/${{ matrix.batch }}" ./
            # If there's a prebuilt zip in the repo, extract it here
            elif [ -f "Antares_Simulator_Tests_NR/${{ matrix.batch }}.zip" ]; then
              echo "Found prebuilt zip Antares_Simulator_Tests_NR/${{ matrix.batch }}.zip, extracting to ./"
              unzip -q "Antares_Simulator_Tests_NR/${{ matrix.batch }}.zip"
            else
              echo "Directory listing for Antares_Simulator_Tests_NR:"
              ls -la Antares_Simulator_Tests_NR || true
              echo "ERROR: neither directory nor zip found for batch: Antares_Simulator_Tests_NR/${{ matrix.batch }} (or .zip)"
              exit 1
            fi

        - name: Download Antares_Simulator_Tests from release
          if: ${{ needs.release.outputs.antares_tests_tag != 'main' }}
          shell: bash
          run: |
            set -euo pipefail
            echo "Downloading ${{ matrix.batch }}.zip from Antares_Simulator_Tests_NR releases tag ${{ needs.release.outputs.antares_tests_tag }}"
            wget https://github.com/AntaresSimulatorTeam/Antares_Simulator_Tests_NR/releases/download/${{ needs.release.outputs.antares_tests_tag }}/${{ matrix.batch }}.zip -O input.zip

        - name: Unpack test studies, clean archive
          if: ${{ needs.release.outputs.antares_tests_tag != 'main' }}
          shell: bash
          run: |
            unzip -q input.zip
            rm input.zip

        - name: Generate results (Ubuntu)
          if: ${{ startsWith(matrix.os, 'ubuntu') }}
          run: |
            ANTARES_TAG=${{ needs.release.outputs.antares_tag }}
            python3 scripts/generate_reference.py ${{ matrix.batch }} antares-solver

        - name: Generate results (Windows)
          if: ${{ startsWith(matrix.os, 'windows') }}
          run: |
            ANTARES_TAG=${{ needs.release.outputs.antares_tag }}
            python3 scripts/generate_reference.py ${{ matrix.batch }} antares-solver.exe
          shell: bash

        - name: Write tags to file
          shell: bash
          run: |
            echo Antares_Simulator ${{ needs.release.outputs.antares_tag }} >> ${{ matrix.batch }}/version.txt
            echo Antares_Simulator_Tests_NR ${{ needs.release.outputs.antares_tests_tag }} >> ${{ matrix.batch }}/version.txt
            echo SimTest ${{ needs.release.outputs.release_tag }} >> ${{ matrix.batch }}/version.txt

        - name: zip results
          run: zip -q -r ${{ matrix.batch }}-${{ matrix.os }}.zip ${{ matrix.batch }}

        - name: Upload .zip
          env:
            tag: ${{ needs.release.outputs.release_tag }}
          shell: bash
          run: |
            gh release upload "$tag" ${{ matrix.batch }}-${{ matrix.os }}.zip --repo="AntaresSimulatorTeam/SimTest"
            gh release upload "$tag" ${{ matrix.batch }}-${{ matrix.os }}.zip --repo="AntaresSimulatorTeam/SimTest"
